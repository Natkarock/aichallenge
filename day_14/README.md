# Проектный анализатор (CLI) — на русском

Устойчивый к «висячим» файлам CLI‑агент для анализа **любой** кодовой базы.
Поддерживает:
- учёт `.gitignore`;
- пропуск тяжёлых/шумных файлов (lockfiles, sourcemaps, minified);
- чтение только «головы» текстовых файлов (без загрузки целиком);
- таймаут на обработку **каждого** файла;
- ограничение числа чанков для одного файла;
- семантический поиск (embeddings) и выборку релевантных фрагментов;
- стриминговый вызов LLM c аккуратным построчным выводом;
- Markdown‑отчёт.

> По умолчанию настроен на **русские промпты** и модель **gpt-4.1**.

---

## Установка

```bash
python3 -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
export OPENAI_API_KEY="sk-..."
```

## Запуск

```bash
python -m analyzer.cli /path/to/project   --top-k 48   --max-file-bytes 1500000   --max-file-chars 120000   --scan-timeout-ms 800   --max-chunks-per-file 100   --verbose-files
```

Минимальный пример (со значениями по умолчанию):

```bash
python -m analyzer.cli /path/to/project
```

## Аргументы

- `project_root` — путь к корню проекта.
- `--exclude-dirs` — дополнительные имена директорий для исключения (помимо встроенных).
- `--max-files` — ограничить общее число файлов.
- `--embed-model` — модель эмбеддингов (по умолчанию `text-embedding-3-large`).
- `--llm-model` — LLM‑модель (по умолчанию `gpt-4.1`).
- `--top-k` — сколько чанков передавать LLM.
- `--max-chars` — размер чанка (символов).
- `--overlap` — перекрытие между чанк‑ами.
- `--max-file-bytes` — порог по размеру файла для предварительного отсечения.
- `--max-file-chars` — сколько символов «головы» читать у текстовых файлов.
- `--scan-timeout-ms` — таймаут (мс) на обработку **одного** файла.
- `--max-chunks-per-file` — максимум чанков для одного файла.
- `--no-gitignore` — игнорировать `.gitignore` (по умолчанию учитывается).
- `--skip-lockfiles/--no-skip-lockfiles` — пропускать lock‑файлы (вкл. по умолчанию).
- `--skip-minified/--no-skip-minified` — пропускать `.min.js/.min.css` (вкл. по умолчанию).
- `--skip-sourcemaps/--no-skip-sourcemaps` — пропускать `*.map` (вкл. по умолчанию).
- `--verbose-files` — печатать обрабатываемые файлы.
- `--report-md` — имя Markdown‑отчёта.

## Что делает агент

1. Сканирует проект (учитывая `.gitignore`) и собирает список файлов.
2. Для текстовых файлов читает «голову», режет на чанк‑и с ограничениями.
   Для бинарных — создаёт мета‑чанк с путём/размером/MIME.
3. Строит эмбеддинги и находит релевантные чанк‑и под задачу анализа.
4. Формирует русский промпт и вызывает LLM со стримингом.
5. Печатает ответ построчно и сохраняет в `analysis_report.md`.

## Совет

- Для больших репозиториев начните с более жёстких ограничений:
  ```bash
  --max-file-bytes 1000000 --max-file-chars 80000 --scan-timeout-ms 700
  ```
- Если надо проанализировать lock‑файлы, выключите пропуск:
  ```bash
  --no-skip-lockfiles
  ```

## Лицензия

MIT
