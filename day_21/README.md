# Проектный анализатор (CLI)  — (многоэтапный анализ, кэш эмбеддингов, rerunk)

## Установка

```bash
python3 -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
export OPENAI_API_KEY="sk-..."
```

## Запуск (многоэтапный режим)

```bash
python -m analyzer.cli /path/to/project   --multi-stage   --module-top-k 36   --global-top-k 48   --max-file-bytes 1500000   --max-file-chars 120000   --scan-timeout-ms 800   --max-chunks-per-file 100   --verbose-files
```

Обычный (одноэтапный) режим по-прежнему доступен:

```bash
python -m analyzer.cli /path/to/project
```

## Параметры (новые ключи)

- `project_root` — путь к корню проекта.
- `--exclude-dirs` — дополнительные имена директорий для исключения (помимо встроенных).
- `--max-files` — ограничить общее число файлов.
- `--embed-model` — модель эмбеддингов (по умолчанию `text-embedding-3-large`).
- `--llm-model` — LLM‑модель (по умолчанию `gpt-4.1`).
- `--top-k` — сколько чанков передавать LLM.
- `--max-chars` — размер чанка (символов).
- `--overlap` — перекрытие между чанк‑ами.
- `--max-file-bytes` — порог по размеру файла для предварительного отсечения.
- `--max-file-chars` — сколько символов «головы» читать у текстовых файлов.
- `--scan-timeout-ms` — таймаут (мс) на обработку **одного** файла.
- `--max-chunks-per-file` — максимум чанков для одного файла.
- `--no-gitignore` — игнорировать `.gitignore` (по умолчанию учитывается).
- `--skip-lockfiles/--no-skip-lockfiles` — пропускать lock‑файлы (вкл. по умолчанию).
- `--skip-minified/--no-skip-minified` — пропускать `.min.js/.min.css` (вкл. по умолчанию).
- `--skip-sourcemaps/--no-skip-sourcemaps` — пропускать `*.map` (вкл. по умолчанию).
- `--verbose-files` — печатать обрабатываемые файлы.
- `--report-md` — имя Markdown‑отчёта.
- `--multi-stage` — включить многоэтапный анализ (по модулям + сводный отчёт).
- `--module-top-k` — сколько чанков давать модели на **каждый модуль** (по умолчанию 36).
- `--global-top-k` — сколько чанков давать модели на **глобальный финальный отчёт** (по умолчанию 48).
- `--cache-dir` — каталог для кэша эмбеддингов (по умолчанию: `PROJECT_ROOT/.proj_analyzer_cache`).
- `--no-cache` — не использовать кэш.

## Что делает агент

1. Сканирует проект (учитывая `.gitignore`) и собирает список файлов.
2. Для текстовых файлов читает «голову», режет на чанк‑и с ограничениями.
   Для бинарных — создаёт мета‑чанк с путём/размером/MIME.
3. Строит эмбеддинги и находит релевантные чанк‑и под задачу анализа.
4. Формирует русский промпт и вызывает LLM со стримингом.
5. Печатает ответ построчно и сохраняет в `analysis_report.md`.

## Что делает многоэтапный режим

1. Определяет **модули** (папки верхнего уровня с кодовыми файлами) + `root_files` (файлы на корне).
2. Для каждого модуля:
   - выполняет retrieval и даёт модели `--module-top-k` чанков;
   - получает и сохраняет **модульный отчёт**.
3. Формирует **финальный запрос**:
   - контекст = краткие выдержки из модульных отчётов + глобально-релевантные чанки;
   - модель пишет **итоговый обзор архитектуры** + общий список рисков и план действий.

Результаты сохраняются в:

- `reports/module_{name}.md`
- `reports/analysis_report.md` (финальный сводный отчёт)

## Лицензия

MIT


## Реранкинг и фильтрация (второй этап поиска)

Теперь после векторного поиска можно включить второй этап — **reranker** (например, Cohere), который переупорядочит кандидатов и отсечёт нерелевантные.

### Быстрый старт

```bash
pip install cohere
export COHERE_API_KEY="your_cohere_key"

python -m analyzer.cli /path/to/project \
  --reranker cohere \
  --preselect-factor 5 \
  --rerank-threshold 0.25 \
  --compare-rerank
```

- `--reranker {none,cohere}` — выбрать реализацию (по умолчанию `none` — поведение не изменится).
- `--preselect-factor` — во сколько раз шире брать пул кандидатов **до** реранка (по умолчанию 5).
- `--rerank-top-k` — сколько оставить после реранка (если не задан, используется `--top-k`).
- `--rerank-threshold` — порог релевантности; кандидаты ниже порога отбрасываются.
- `--compare-rerank` — сохраняет **два** отчёта (`analysis_report_baseline.md` и `analysis_report_rerank.md`) и файл `analysis_report_comparison.md` с кратким сравнением.

### Что внутри

1. **Векторная предвыборка**: косинусная близость по эмбеддингам выбирает `top_k * preselect_factor` кандидатов.
2. **Rerank**: модель (например, `cohere rerank-multilingual-v3.0`) сортирует по релевантности к запросу.
3. **Порог/Top‑K**: применяется `--rerank-threshold` и затем берутся `--rerank-top-k` (или `--top-k`).

Если не задать `--reranker`, пайплайн полностью совпадает с прежним.
