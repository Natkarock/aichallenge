# üß† Weather MCP Agent + Multi-Chat UI

## ‚úÖ –ß—Ç–æ –Ω–æ–≤–æ–≥–æ —Å–µ–≥–æ–¥–Ω—è

- üì¶ **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –º–æ–¥—É–ª–µ–π**: –≤—ã–Ω–µ—Å–µ–Ω—ã `cache.py` (—Ö—Ä–∞–Ω–∏–ª–∏—â–µ) –∏ `llm.py` (–≤—ã–∑–æ–≤ –º–æ–¥–µ–ª–∏).
- üóÑÔ∏è **–•—Ä–∞–Ω–∏–ª–∏—â–µ SQLite** –≤–º–µ—Å—Ç–æ JSON (`memory/chats.db`) —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –º–∏–≥—Ä–∞—Ü–∏–µ–π –∏–∑ `memory/chats.json`.
- üóëÔ∏è **–£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–æ–≤**: —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –≤ —Å–∞–π–¥–±–∞—Ä–µ + –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–±–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞.
- üßæ **–°–∞–º–º–∞—Ä–∏–∑–∞—Ü–∏—è** –∫–∞–∂–¥—ã—Ö 10 —Å–æ–æ–±—â–µ–Ω–∏–π (running summary) –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–æ–¥–µ–ª–∏, **–ø—Ä–∏ —ç—Ç–æ–º –≤—Å—è –∏—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è** –≤ –ë–î.


## üå¶Ô∏è –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç

–≠—Ç–æ **Streamlit-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**, –æ–±—ä–µ–¥–∏–Ω—è—é—â–µ–µ –¥–≤–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã:

### 1) ‚õÖ –ü–æ–≥–æ–¥–Ω—ã–π MCP-–∞–≥–µ–Ω—Ç
MCP (Multi-Context Pipeline) –∞–≥–µ–Ω—Ç ‚Äî –≥—Ä–∞—Ñ –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —à–∞–≥–æ–≤ (LangGraph/LangChain), –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å –≤–Ω–µ—à–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:

1. `model_call_with_tools` ‚Äî —Ä–µ—à–∞–µ—Ç, –∫–∞–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤—ã–∑–≤–∞—Ç—å  
2. `call_weather` ‚Äî –ø–æ–ª—É—á–∞–µ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–≥–Ω–æ–∑  
3. `call_image_generation` ‚Äî —Å–æ–∑–¥–∞—ë—Ç –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏/–∫–∞—Ä—Ç–∏–Ω–∫–∏  
4. `call_pdf_to_markdown` ‚Äî –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç PDF-–æ—Ç—á—ë—Ç—ã  
5. `call_final_answer` ‚Äî —Å–æ–±–∏—Ä–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** —Ç–µ–∫—Å—Ç, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, PDF-–æ—Ç—á—ë—Ç, `thread_id` (–¥–ª—è —á–µ–∫–ø–æ–∏–Ω—Ç–µ—Ä–∞).

### 2) üí¨ –ú—É–ª—å—Ç–∏-—á–∞—Ç —Å –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç—å—é
- ¬´‚ûï –ù–æ–≤—ã–π —á–∞—Ç¬ª, –≤—ã–±–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞ –∏ ¬´üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —á–∞—Ç¬ª ‚Äî –≤ **—Å–∞–π–¥–±–∞—Ä–µ** (–≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã).
- –ò—Å—Ç–æ—Ä–∏—è –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —á–∞—Ç–æ–≤ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ **SQLite** (`memory/chats.db`).
- **–°–∞–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥—ã—Ö 10 —Å–æ–æ–±—â–µ–Ω–∏–π**: —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–æ–ª–µ `summary` —Ç–∞–±–ª–∏—Ü—ã `chats`, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ —Å–∂–∞—Ç—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è LLM.
- **–ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è** —Å–æ–æ–±—â–µ–Ω–∏–π (—Ç–∞–±–ª–∏—Ü–∞ `messages`) **–Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è** ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ü–µ–ª–∏–∫–æ–º.

---

## üóÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
project/
‚îú‚îÄ main.py               # UI: MCP + —á–∞—Ç—ã (—Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Å–∞–π–¥–±–∞—Ä —Å –∫–ª—é—á–∞–º–∏)
‚îú‚îÄ agent.py              # MCP-–≥—Ä–∞—Ñ (–≤—ã–∑–æ–≤—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤)
‚îú‚îÄ cache.py              # –•—Ä–∞–Ω–∏–ª–∏—â–µ: SQLite (chats.db), –º–∏–≥—Ä–∞—Ü–∏—è, CRUD
‚îú‚îÄ llm.py                # –í—ã–∑–æ–≤ –º–æ–¥–µ–ª–∏ + summarize / generate_reply (–æ–∫–Ω–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
‚îú‚îÄ memory/
‚îÇ  ‚îú‚îÄ chats.db           # –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å —á–∞—Ç–æ–≤ (SQLite)
‚îÇ  ‚îî‚îÄ chats.json         # (–æ–ø—Ü.) –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
‚îî‚îÄ requirements.txt
```

### –°—Ö–µ–º–∞ –ë–î (SQLite)

- **chats**: `id TEXT PK`, `title TEXT`, `created_at TEXT`, `summary TEXT`  
- **messages**: `id INTEGER PK`, `chat_id TEXT`, `role TEXT`, `content TEXT`, `ts TEXT`

---

## ‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

```bash
pip install -r requirements.txt
streamlit run main.py
```

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**

- `OPENAI_API_KEY` ‚Äî –∫–ª—é—á OpenAI  
- `OPENAI_MODEL` ‚Äî –º–æ–¥–µ–ª—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `gpt-4.1-mini`)  
- `OPENAI_TEMPERATURE` ‚Äî —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `0.2`)  
- `CONTEXT_WINDOW_MESSAGES` ‚Äî –æ–∫–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã—Ö –≤ LLM (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `12`)  
- `SUMMARY_TARGET_TOKENS` ‚Äî —Ü–µ–ª–µ–≤–æ–π —Ä–∞–∑–º–µ—Ä —Å–∞–º–º–∞—Ä–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `250`)

**–î–ª—è MCP —á–µ–∫–ø–æ–∏–Ω—Ç–µ—Ä–∞ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å):**
```bash
pip install -U langgraph langgraph-checkpoint-sqlite
```

---

## üîÅ –°–∞–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–∫–∞–∂–¥—ã–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π)

- –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞, –µ—Å–ª–∏ –æ–±—â–µ–µ —á–∏—Å–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞ `% 10 == 0`, –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è `summarize_messages(...)` –∏–∑ `llm.py`.
- –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `chats.summary` (—Ç–∞–±–ª–∏—Ü–∞ SQLite) –∏ –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π —Å—Ç–æ—Ä, –∏ –∑–∞—Ç–µ–º –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ **–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π `SystemMessage`** –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ `generate_reply(...)`.
- –ú–æ–¥–µ–ª—å –ø—Ä–∏ —ç—Ç–æ–º –≤–∏–¥–∏—Ç **—Å–≤–æ–¥–∫—É** + **–ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π** (`CONTEXT_WINDOW_MESSAGES`), —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–ø–æ–ª–Ω—è—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç.
- –í—Å—è **–ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è** –æ—Å—Ç–∞—ë—Ç—Å—è –≤ `messages` –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∫–∞–∑–∞–Ω–∞ –≤ UI/—ç–∫—Å–ø–æ—Ä—Ç–µ.

---

## üóëÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏ (—Å–∞–π–¥–±–∞—Ä)

- **–°–æ–∑–¥–∞—Ç—å —á–∞—Ç:** –∫–Ω–æ–ø–∫–∞ ¬´‚ûï –ù–æ–≤—ã–π —á–∞—Ç¬ª.  
- **–í—ã–±–æ—Ä —á–∞—Ç–∞:** `selectbox` —Å –∫–ª—é—á–æ–º `key="select_chat_id"`.  
- **–£–¥–∞–ª–∏—Ç—å —á–∞—Ç:** –∫–Ω–æ–ø–∫–∞ ¬´üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —á–∞—Ç¬ª (`key="btn_delete_chat"`).  
- –í—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–º–µ—é—Ç **—É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏**, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å `StreamlitDuplicateElementId` –ø—Ä–∏ –ª—é–±—ã—Ö —Ä–µ—Ä–µ–Ω–¥–µ—Ä–∞—Ö.


---

## üöö –ú–∏–≥—Ä–∞—Ü–∏—è —Å JSON –Ω–∞ SQLite

1. –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ `cache.py` —Å–æ–∑–¥–∞—Å—Ç `memory/chats.db`.  
2. –ï—Å–ª–∏ –Ω–∞–π–¥—ë—Ç `memory/chats.json` –∏ –ë–î –ø—É—Å—Ç–∞—è ‚Äî **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç** —á–∞—Ç—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è.  
3. –î–∞–ª—å—à–µ —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å –∏–¥—É—Ç –≤ SQLite. `chats.json` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è.

---


## üß≠ –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã MCP

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ö–∞–∫–∞—è –ø–æ–≥–æ–¥–∞ –∑–∞–≤—Ç—Ä–∞ –≤ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ?"

‚Üí model_call_with_tools ‚Üí –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω—É–∂–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
‚Üí call_weather ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑
‚Üí call_image_generation ‚Üí —Å–æ–∑–¥–∞—ë—Ç –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏
‚Üí call_final_answer ‚Üí —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç

–†–µ–∑—É–ª—å—Ç–∞—Ç:
‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–≥–æ–¥—ã
‚úÖ –ö–∞—Ä—Ç–∏–Ω–∫–∏
‚úÖ PDF —Å –ø—Ä–æ–≥–Ω–æ–∑–æ–º
```
